# -------- Base stage --------
FROM node:20-alpine AS base
WORKDIR /app
ENV NODE_ENV=production

# -------- Dependencies stage --------
FROM base AS deps

# Copy only package files first (better caching)
COPY package*.json ./

# Install only production dependencies
RUN npm ci --omit=dev

# -------- Build stage (if you use TypeScript or build step) --------
# If you DON'T have a build step, you can remove this stage
FROM base AS build
WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

# -------- Runtime stage --------
FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production

# Add a non-root user for security
RUN addgroup -S nodejs && adduser -S nodejs -G nodejs

# Copy dependencies
COPY --from=deps /app/node_modules ./node_modules

# Copy built app (or src if no build)
COPY --from=build /app/dist ./dist
# If you don't build, use:
# COPY . .

# Change ownership
RUN chown -R nodejs:nodejs /app

USER nodejs

EXPOSE 3000

CMD ["node", "dist/index.js"]
